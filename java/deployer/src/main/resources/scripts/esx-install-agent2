#!/bin/bash

tools=$(readlink -nf $(dirname $0))
source $tools/common.sh

function usage() {
  echo "Usage: $0 HOST_ADDRESS USERNAME PASSWORD VIB_PATH CREATE_CERT LW_DOMAIN LW_ADDRESS LW_PASSWORD" 1>&2
  echo
  echo "Supplied args:"
  echo $*
  exit 1
}

host_address=""
username=""
password=""
vib_path=""
create_cert=""
lightwave_domain=""
lightwave_address=""
lightwave_password=""

if [ "$#" -lt 8 ]
then
  usage $*
fi

host_address=$1
shift
username=$1
shift
password=$1
shift
vib_path=$1
shift
create_cert=$1
shift
lightwave_domain=$1
shift
lightwave_address=$1
shift
lightwave_password=$1
shift



while getopts d:l:n:h flag
do
  case $flag in
    ?)
      usage $*
      ;;
  esac
done

function install_vib() {
  sshpass -p "$password" ssh -o StrictHostKeyChecking=no ${username}@${host_address} esxcli software vib install -f -v $vib_path
  if [[ $? -ne 0 ]]
  then
    echo "retrying installing vib"
	  sshpass -p "$password" ssh -o StrictHostKeyChecking=no ${username}@${host_address} esxcli software vib install -f -v $vib_path

	  if [[ $? -ne 0 ]]
	  then
	    exit 1
	  fi
	fi
}

function join_lightwave_domain() {
  sshpass -p "$password" ssh -o StrictHostKeyChecking=no ${username}@${host_address} /etc/init.d/vmafdd start
  sshpass -p "$password" ssh -o StrictHostKeyChecking=no ${username}@${host_address} "/usr/lib/vmware/ic-deploy/bin/ic-deploy\
              --mode client --hostname ${host_address} --server ${lightwave_address} --domain ${lightwave_domain}\
              --password ${lightwave_password}"
  sshpass -p "$password" ssh -o StrictHostKeyChecking=no ${username}@${host_address} /usr/lib/vmware/vmafd/bin/vecs-cli\
              entry list --store MACHINE_SSL_CERT --text
}

sshpass -p "$password" ssh -o StrictHostKeyChecking=no ${username}@${host_address} date
sshpass -p "$password" ssh -o StrictHostKeyChecking=no ${username}@${host_address} esxcli software vib list

install_vib

sshpass -p "$password" ssh -o StrictHostKeyChecking=no ${username}@${host_address} esxcli software vib list
sshpass -p "$password" ssh -o StrictHostKeyChecking=no ${username}@${host_address} date

echo "create_cert=${create_cert}, vib_path=${vib_path}"
if [[ "$create_cert" == "true" && "$vib_path" == *"lightwave"* ]]
then
  echo "Join lightwave: host_address=${host_address}, lw_address=${lightwave_address}, lw_domain=${lightwave_domain}"
  join_lightwave_domain
fi
