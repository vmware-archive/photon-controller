#cloud-config

groups:
  - photon: [photon]

users:
  - default
  - name: root
    plain_text_passwd: changeme
    lock-passwd: false
  - name: photon
    gecos: photon user
    primary-group: photon
    plain_text_passwd: changeme
    groups: root
    lock-passwd: false
    sudo: ALL=(ALL) NOPASSWD:ALL

write_files:
  - content: |
        en_name=$(ip addr show label "e*" | head -n 1 | sed 's/^[0-9]*: \(e.*\): .*/\1/')
        cat > "/etc/systemd/network/10-dhcp-${en_name}.network" << EOF
        [Match]
        Name=$en_name

        [Network]
        Address=192.168.0.0/16
    owner: root:root
    path: /tmp/init-network.sh

  - content: |
        dhcp-range=192.168.0.1,192.168.0.1,24h
    owner: root:root
    path: /etc/dnsmasq.conf

  - content: |
        [Unit]
        Description=DHCP server
        After=network.target

        [Service]
        ExecStart=/usr/sbin/dnsmasq --keep-in-foreground --conf-file=/etc/dnsmasq.conf
        ExecReload=/bin/kill -HUP $MAINPID
        Restart=on-failure
        RestartSec=1

        [Install]
        WantedBy=multi-user.target
    owner: root:root
    path: /etc/systemd/system/dnsmasq.service


runcmd:
  - rm -f /etc/systemd/network/*.network
  - sh /tmp/init-network.sh
  - systemctl restart systemd-networkd
  - systemctl enable dnsmasq.service
  - systemctl start dnsmasq.service
